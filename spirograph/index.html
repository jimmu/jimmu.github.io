<html>
  <head>
    <title>Hello</title>
    <style>
      body {
        background-image: url('water.png');
        background-size: cover; #contain;
      }
    </style>
    <script>
      const fps=50;
      const speedBoost=1;  // Increase this to decrease all the periods at the cost of resolution
      const lineWidth=0.5;
      const solidLines = true; // Dots or continuous lines.

      var container;
      var running = false;
      var centreX;
      var centreY;

      // Change the things in allTheThings to be trees.
      // allTheThings is the array of things attached to the origin.
      // each thing will then need to chain children on by having a new
      // field called children.
      var allTheThings=[];
      var context;

      function newCogs(){
        // Text is offset from the trace because the canvas is shifted down under the input box.
        running = false;
        cogs = JSON.parse(event.target.value);
        console.log(JSON.stringify(cogs));
        container.replaceChildren();
        allTheThings = [];
        setupGfx();
        for (cog of cogs){
          makeMeee(cog, allTheThings);
        }
        running = true;
        console.log(allTheThings);
        return false;
      }

      function createEverything(){
        setupGfx();        
        setInterval(moveEverything, 1000/fps);
        running = true;
      }

      function moveEverything(){
        if (running){
          moveTheseAtThisOrigin(allTheThings, centreX, centreY);
        }
      }	

      function moveTheseAtThisOrigin(things, originX, originY){
          for (thing of things){
            var spirograph = thing.trace && thing.x;
            if (spirograph && solidLines) {
              context.beginPath();
              context.moveTo(thing.x, thing.y);
            }

            var xCoord = originX + Math.cos(thing.angle)*thing.radius;
            var yCoord = originY + Math.sin(thing.angle)*thing.radius;   
            thing.angle = (thing.angle + thing.increment)%(2*Math.PI);
            thing.x = xCoord;
            thing.y = yCoord;
            thing.element.style.left = xCoord;
            thing.element.style.top = yCoord;

            // Draw to the new position
            if (spirograph) {
              if (solidLines){
                context.strokeStyle=thing.trace;
                context.lineTo(xCoord, yCoord);
                context.stroke();
              }
              else {
                context.fillRect(xCoord, yCoord, 2*lineWidth, 2*lineWidth);
              }
            }

            if (thing.children){
              moveTheseAtThisOrigin(thing.children, thing.x, thing.y);
            }
          }
      }

      function makeMeee(aThing, parent){
        var aNewElement = newElement("o");
        var thisThing = {
               element: aNewElement,
               radius: aThing.radius,
               period: aThing.period,
               angle: 0,
               increment: speedBoost*(2*Math.PI)/(fps*aThing.period),
               trace: aThing.trace,
               children: []
        }
        parent.push(thisThing);
        container.appendChild(aNewElement);        
        if (aThing.children){
          console.log("Creating children");
          for (child of aThing.children){
            makeMeee(child, thisThing.children);
          }
        }
      }

      function newElement(text){
        var element=document.createElement("text");
        element.style.position="absolute";
        element.textContent=text;
        return element;
      }	

      function setupGfx(){
        container=document.getElementById("x");
        centreX = window.innerWidth/2;
        centreY = window.innerHeight/2;
        var canvas=document.getElementById("c");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        context = canvas.getContext('2d');
        context.lineWidth = lineWidth;
        context.lineCap = "round";
      }
    </script>
  </head>
  <body>
    <form>
      <input id="z" size="100" onchange="newCogs()"> 
    </form>
    <canvas id="c"></canvas>
    <div id="x"></div>
    <script>
      createEverything();
    </script>
  </body>
</html>
